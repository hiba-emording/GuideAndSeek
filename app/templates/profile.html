{% extends "base.html" %}

{% block content %}
  <div class="max-w-4xl mx-auto p-6 bg-white rounded-lg shadow-md">
    <h2 class="text-2xl font-bold mb-4 text-purple-600">{{ user.username }}'s Profile</h2>
    <img src="{{ user.profile_picture }}" alt="Profile Picture" class="w-32 h-32 rounded-full mb-4 shadow-lg">

    <p>
        <span class="badge {{ 'bg-#FFCC80 text-orange-800' if user.role == 'teacher' else 'bg-#A89BC5 text-gray-800' }} inline-block px-2 py-1 rounded-full">
          {{ user.role }}
        </span>
    </p>
    <p class="mb-2"><strong>Bio:</strong> {{ user.bio }}</p>
    <p class="mb-2"><strong>Country:</strong> {{ user.country }}</p>
    <p class="mb-2"><strong>Level:</strong> {{ user.level }}</p>

    <!-- Display subjects as a list -->
    <p class="mb-4"><strong>Subjects of Interest:</strong></p>
    <ul class="list-disc pl-5 text-gray-700">
      {% for subject in user_subjects %}
      <li>{{ subject }}</li>
      {% endfor %}
    </ul>

    {% if current_user.id == user.id %}
      <a href="{{ url_for('api.edit_profile') }}" class="inline-block bg-light-orange text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">Edit Profile</a>
    {% endif %}

    <div class="container mx-auto p-4">
      {% if user.role == 'teacher' and current_user.role.lower() == 'student' %}
        <!-- Only allow students to see these options on a teacher's profile -->
        <a href="{{ url_for('api.book_appointment', teacher_id=user.id) }}" class="bg-light-orange text-white px-4 py-2 rounded mt-4 hover:bg-orange-600 transition">Ask for Appointment</a>
        <a href="#" class="bg-purple-600 text-white px-4 py-2 rounded mt-4 hover:bg-purple-700 transition" id="leaveReviewButton">Leave Review</a>

        <!-- Review Form -->
        <div id="reviewForm" class="mt-6 hidden">
            <h3 class="text-lg font-semibold text-purple-600">Leave a Review</h3>
            <form action="{{ url_for('api.leave_review', teacher_id=user.id) }}" method="POST">
                {{ review_form.hidden_tag() }}
                <div class="mb-4">
                    <label for="rating" class="block text-sm font-medium text-gray-700">Rating:</label>
                    {{ review_form.rating(class="block w-full mt-1") }}
                </div>
                <div class="mb-4">
                    <label for="comment" class="block text-sm font-medium text-gray-700">Comment:</label>
                    {{ review_form.comment(class="block w-full mt-1") }}
                </div>
                <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition">Submit Review</button>
            </form>
        </div>
      {% endif %}

      {% if user.role == 'teacher' %}
      <!-- Show reviews only for teacher profiles -->
      <h3 class="text-2xl font-bold mt-8 text-purple-600">Reviews</h3>
      <div>
          {% for review in reviews.items %}
          <div class="bg-gray-100 p-4 my-2 rounded-lg shadow-sm">
              <p><strong>Rating:</strong> {{ review.rating }} / 5</p>
              <p><strong>Comment:</strong> {{ review.comment or 'No comment' }}</p>
              <p>
                  <strong>Reviewed by:</strong>
                  <a href="{{ url_for('api.view_profile', user_id=review.student_id) }}" class="text-purple-600 hover:underline">
                      {{ review.student.username }}
                  </a>
              </p>
          </div>
          {% endfor %}
      </div>      
  
      <!-- Pagination -->
      <div class="mt-4">
        <ul class="flex justify-center space-x-2">
            {% if reviews.has_prev %}
            <li><a href="{{ url_for('api.view_profile', user_id=user.id, page=reviews.prev_num) }}" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">Previous</a></li>
            {% endif %}
            {% if reviews.has_next %}
            <li><a href="{{ url_for('api.view_profile', user_id=user.id, page=reviews.next_num) }}" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">Next</a></li>
            {% endif %}
        </ul>
      </div>
  {% endif %}  
    </div>
  </div>  
  <script>
    // Show the review form when the "Leave Review" button is clicked
    document.getElementById('leaveReviewButton').onclick = function() {
        var form = document.getElementById('reviewForm');
        form.classList.toggle('hidden');
    };
</script>
{% endblock %}
